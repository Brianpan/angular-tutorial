(function(){
  var app = angular.module("project", ["ngRoute", "templates"]);

  app.config(['$routeProvider', function($routeProvider){
    $routeProvider.when("/", {
      controller: "PanelController",
      templateUrl: "projects/panel.html"
    });
    $routeProvider.when("/projects/edit/:projectID", {
      controller: "EditController",
      templateUrl: "projects/form.html"
    });
  }]);
  
  ///main controller
  app.controller("MainController", function($scope, $http){
    $scope.addCount = function(){
      $scope.count += 1;	
    }
    this.count = 0;
    $http.get('project_list.json').success(function(data){
      $scope.projects = data.projects;
      $scope.count = data.projects.length;
    });
  });
  
  
  ///angular controllers
  app.controller("PanelController", function(){
    this.tab = 1;
    this.setTab = function(val){
      this.tab = val;	
    };
    this.isTab = function(val){
      return(this.tab === val);
    };
  });
  
  app.controller("NewController", function($scope, $http, $location, $routeParams){
    this.project = {};
    this.addProject = function(){
      $scope.projects.push(this.project);
      $scope.addCount();
      this.project = {};
      $location.path("/");
    };
    
  });
  
  app.controller("EditController", function($scope, $http, $location, $routeParams){
    $scope.project = {};
    var projectId = parseInt($routeParams.projectID);
    var projects = $scope.projects;
    var target = $.grep(projects, function(e){return e.id == projectId})[0];
    var index = projects.indexOf(target);
    
    $scope.project = target;
    
    $scope.editProject = function(){
      
      /////update
      delete $scope.project["$$hashKey"];
      $scope.projects[index] = $scope.project;
      ///update backend
      //
      $.ajax({
        type: "PUT",
        contentType: 'application/json',
        url: '/projects/'+ String(projectId),
        data: JSON.stringify({project: $scope.project, id: projectId,  _method: 'put'})
      }).then(function(data){
        
        $location.path("/");
        ///call scope outside of the angular
        $scope.$apply();
      });
      
    };
  });

})();